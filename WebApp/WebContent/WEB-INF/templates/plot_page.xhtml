<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
  xmlns:h="http://xmlns.jcp.org/jsf/html"
  xmlns:f="http://xmlns.jcp.org/jsf/core"
  xmlns:p="http://primefaces.org/ui"
  xmlns:ui="http://xmlns.jcp.org/jsf/facelets">

<h:head>
  <title><ui:insert name="title">Welcome</ui:insert> - #{utils.siteName}</title>
  <h:outputScript library="primefaces" name="jquery/jquery.js" />
  <ui:insert name="localHead"></ui:insert>
  <h:outputScript name="script/jquery.splitter.js" />
  <h:outputStylesheet name="style/jquery.splitter.css" />
  <h:outputScript name="script/leaflet.js" />
  <h:outputStylesheet name="style/leaflet.css" />
  <h:outputScript name="script/jsColorScale.js" />
  <h:outputScript name="script/datatables.min.js" />
  <h:outputStylesheet name="style/datatables.min.css" />
  <h:outputScript name="script/dygraph.min.js" />
  <h:outputStylesheet name="style/dygraph.css" />

  <!-- The script that controls all the page actions -->
  <h:outputScript name="script/plotPage.js" />
</h:head>

<h:body class="fullPage">
  <ui:include src="/WEB-INF/templates/keep_alive.xhtml" />
  <!--  The main stylesheet goes here because it can then override PrimeFaces styles -->
  <h:outputStylesheet name="style/main.css" />
  <h:outputStylesheet name="style/plotPage.css" />
  
  <ui:insert name="localStylesheets"></ui:insert>

  <!-- General form for page-level data, commands etc -->
  <h:form id="plotPageForm" method="post">
    <h:inputHidden id="error"
      value="#{sessionScope[beanName].error}" />

    <h:inputHidden id="canEdit" value="#{sessionScope[beanName].canEdit}"/>

    <h:inputHidden id="columnHeadings"
      value="#{sessionScope[beanName].data.columnHeadingsJson}" />
    <h:inputHidden id="extendedColumnHeadings"
      value="#{sessionScope[beanName].data.extendedColumnHeadingsJson}" />

    <h:inputHidden id="rowIDs"
      value="#{sessionScope[beanName].data.rowIDsJson}" />

    <h:inputHidden id="dataBounds"
      value="#{sessionScope[beanName].dataBounds}" />

  <ui:insert name="loadDataCommand"></ui:insert>

  </h:form>

  <!-- Form for table data -->
  <h:form id="tableForm" method="post">
    <h:inputHidden value="#{sessionScope[beanName].tableJsonData}"
      id="tableJsonData" />
    <h:inputHidden value="#{sessionScope[beanName].recordCount}"
      id="recordCount" />
    <h:inputHidden value="#{sessionScope[beanName].tableDataDraw}"
      id="tableDataDraw" />
    <h:inputHidden value="#{sessionScope[beanName].tableDataStart}"
      id="tableDataStart" />
    <h:inputHidden value="#{sessionScope[beanName].tableDataLength}"
      id="tableDataLength" />
    <p:remoteCommand name="tableGetData"
      action="#{sessionScope[beanName].generateTableData}"
      process="tableDataDraw tableDataStart tableDataLength"
      update="tableJsonData tableDataDraw recordCount"
      oncomplete="tableDataDownload()" />
  </h:form>

  <p:dialog header="Please wait" widgetVar="pleaseWait" modal="true"
    resizable="false" closable="false">
    <h:form id="pleaseWaitForm">
      <p:remoteCommand name="updateProgress"
        action="#{sessionScope[beanName].noop}"
        process="@none" update="progressName progressBar"/>

      Preparing data. This can take quite a while, so please be patient...
      <h:panelGrid columns="1" cellpadding="5" style="width: 100%">
        <h:outputText id="progressName" value="#{sessionScope[beanName].progress.name}"/>
        <p:progressBar id="progressBar" widgetVar="progressBar"
          value="#{sessionScope[beanName].progress.progress}" mode="determinate"
          ajax="false">
        </p:progressBar>
      </h:panelGrid>
      <h:panelGrid columns="1" cellpadding="5" styleClass="buttonPanel">
        <p:commandButton widgetVar="finishButton" value="Abort" ajax="false"
          process="@none" action="#{sessionScope[beanName].finish}" styleClass="inlineButton" />
      </h:panelGrid>
    </h:form>
  </p:dialog>

  <p:dialog header="Error" widgetVar="errorMessage" modal="true"
    resizable="false" closable="false">

    <h:form id="errorMessageFirm">
      <div class="error">
        ERROR: An error occurred during processing.
        Please report the following to site support:
      </div>

      <div id="errorMessageString" class="instructions">
        ...
      </div>
      <h:panelGrid columns="1" cellpadding="5" styleClass="buttonPanel">
        <p:commandButton id="abortButton" value="Close"
          action="#{sessionScope[beanName].abort}" />
      </h:panelGrid>
    </h:form>
  </p:dialog>

  <p:dialog widgetVar="variableDialog" modal="true" header="Variables"
    resizable="false">
    <div id="variablesList">
      <ui:repeat
        value="#{sessionScope[beanName].data.extendedColumnHeadings.entrySet().toArray()}"
        var="entry">

        <div class="variableGroup">
          <div class="varGroupName">
            <h:outputText value="#{entry.key}" />
          </div>
          <ui:repeat value="#{entry.value}" var="variable">
            <div class="variable">
              <div class="varName varGroupMember">
                <h:outputText value="#{variable.shortName}" />
              </div>
              <div class="variableControls">
                <div id="varInfo-#{variable.id}" class="varInfo"></div>
                <p:selectBooleanCheckbox widgetVar="mapVar-#{variable.id}"
                  id="mapVarCheckbox"
                  onchange="updateMapCheckboxes(#{variable.id})" />
                <p:selectBooleanButton widgetVar="xAxis-#{variable.id}"
                  onLabel="X" offLabel="X" styleClass="axisButton"
                  onchange="axisButtonClicked('x', #{variable.id})" />
                <ui:fragment rendered="#{variable.shortName ne 'Time'}">
                  <p:selectBooleanButton widgetVar="yAxis-#{variable.id}"
                    onLabel="Y" offLabel="Y" styleClass="axisButton"
                    onchange="axisButtonClicked('y', #{variable.id})" />
                  <ui:fragment rendered="#{sessionScope[beanName].dualYAxes()}">
                    <p:selectBooleanButton widgetVar="y2Axis-#{variable.id}"
                      onLabel="Y2" offLabel="Y2" styleClass="wideAxisButton"
                      onchange="axisButtonClicked('y2', #{variable.id})" />
                  </ui:fragment>
                </ui:fragment>
                <ui:fragment rendered="#{variable.shortName eq 'Time'}">
                  <div class="noAxisButton">&nbsp;</div>
                  <ui:fragment rendered="#{sessionScope[beanName].dualYAxes()}">
                    <div class="wideNoAxisButton">&nbsp;</div>
                  </ui:fragment>
                </ui:fragment>
              </div>
            </div>
          </ui:repeat>
        </div>
      </ui:repeat>
    </div>
    <h:panelGrid columns="2" styleClass="buttonPanel">
      <h:form id="applyVariablesForm">
        <p:commandButton widgetVar="variableOk" value="OK"
          onclick="applyVariables();" />
        <p:commandButton value="Cancel" onclick="PF('variableDialog').hide();" />
      </h:form>
    </h:panelGrid>
  </p:dialog>

  <p:dialog widgetVar="notesDialog" modal="true" header="Dataset Notes"
    resizable="false">
    <h:form id="notesForm">
      <div class="instructions">
        These notes will be published in the dataset metadata.
        <br/>
        Semi-colons will be converted to newlines.
      </div>
      <p:inputTextarea id="userNotes"
        value="#{sessionScope[beanName].userComments}"
        style="width: 420px; height: 130px;" autoResize="false"/>

      <h:panelGrid columns="3" styleClass="buttonPanel">
        <p:commandButton widgetVar="notesOK" value="OK"
          onclick="saveNotes();" />
        <p:commandButton widgetVar="notesRevert" value="Revert">
          <p:ajax update="userNotes" resetValues="true"/>
        </p:commandButton>
        <p:commandButton value="Cancel" onclick="cancelNotes();" />

        <p:remoteCommand name="saveComments"
          action="#{sessionScope[beanName].saveUserComments}"
          process="userNotes"
          update="@none"
          oncomplete="PF('notesDialog').hide();" />

        <p:remoteCommand name="resetComments"
          update="userNotes"
          resetValues="true" />
      </h:panelGrid>
    </h:form>
  </p:dialog>

  <p:toolbar styleClass="plotPageHeader">
    <f:facet name="left">
      #{sessionScope[beanName].dataset.name} - <ui:insert name="qcType">Quality Control</ui:insert>
    </f:facet>
    <f:facet name="right">
      <h:form id="statusForm" method="post">
        <ui:insert name="pageStatus"></ui:insert>
      </h:form>
    </f:facet>
  </p:toolbar>

  <div id="plotPageContent" class="plotPageContent">
    <div id="plots">
      <ui:insert name="plots"></ui:insert>
    </div>
    <div id="tableContent"></div>
  </div>

  <p:toolbar id="footerToolbar" styleClass="plotPageFooter">
    <f:facet name="left">
      <!--
      <p:selectOneMenu widgetVar="columnSelector"
        onchange="scrollToColumn(event.target.value)">
        <f:selectItems value="#{sessionScope[beanName].data.columnGroupOffsets}" />
      </p:selectOneMenu>
      -->
    </f:facet>
    <f:facet name="right">
      <div id="qcMessage" class="inline"></div>
      <div id="qcControls">
        <ui:fragment rendered="#{!sessionScope[beanName].canEdit}">
          <span class="instructions">NRT Dataset - cannot be edited</span>
        </ui:fragment>
        <ui:fragment rendered="#{sessionScope[beanName].canEdit}">
          <h:form id="selectionForm" method="post" styleClass="inline">
            Selection:
            <span id="selectedColumnDisplay"></span>
            <span id="selectedRowsCountDisplay">0</span>
            <p:commandButton icon="clearSelectionButton"
              onclick="clearSelection();" styleClass="inlineButton tightIconButton lightButton" />
            <h:inputHidden id="selectedColumn"
              value="#{sessionScope[beanName].data.selectedColumn}" />
            <h:inputHidden id="selectedRows"
              value="#{sessionScope[beanName].data.selectedRows}" />
            <h:inputHidden id="clickedRow"
              value="#{sessionScope[beanName].data.clickedRow}" />
            <h:inputHidden id="prevClickedRow"
              value="#{sessionScope[beanName].data.prevClickedRow}" />
            <h:inputHidden id="lastSelectionAction"
              value="#{sessionScope[beanName].data.lastSelectionAction}" />

            <p:remoteCommand name="selectRange"
              action="#{sessionScope[beanName].data.selectRange}"
              process="@form" update="selectedRows prevClickedRow lastSelectionAction"
              oncomplete="selectionUpdated()" />

            <p:remoteCommand name="updateSelectedRows"
              action="#{sessionScope[beanName].noop}"
              process="selectedRows" update="@none"
              oncomplete="selectionUpdated()" />

            <ui:insert name="selectionDialog" />
            <ui:insert name="selectionFormEntries" />
            <div id="selectionActions" style="display: inline">
              <ui:insert name="selectionActions">Selection actions here</ui:insert>
            </div>
            |
            <p:commandButton widgetVar="notesButton" value="Notes"
              onclick="showNotesDialog(); return false;" styleClass="inlineButton tightTextButton" />
          </h:form>
        </ui:fragment>
        |
        <h:form id="finishButtonForm" method="post" styleClass="inline">
         <p:commandButton widgetVar="finishButton" value="Finish" ajax="false"
           onmousedown="disableKeepAlive();" process="@none" action="#{sessionScope[beanName].finish}"
           styleClass="inlineButton tightTextButton" />
        </h:form>
      </div>
    </f:facet>
  </p:toolbar>

    <script>
      $(document).ready(function (){
        initPage();
      });
    </script>
</h:body>
</html>
